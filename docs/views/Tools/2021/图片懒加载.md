---
title: 图片懒加载
date: 2021-04-14
categories:
 - JavaScript
author: 青菜白玉汤
tags:
 - 有用的小玩意
---

## 引入场景
在页中展示大量图片时，发会大量的http请求，这个就能会造成页面加载慢，影响用户体验，因此就诞生了这样的一个思路，
图片等用到的时候再显示。这样就可以减少大量的http请求。

## 实现技术
1. Element.getBoundingClientRect()
2. Element.clientHeight + HTMLElement.offsetTop + Element.scrollTop
3. IntersectionObserver()


## 实现

### 1. getBoundingClientRect()
该方法返回元素的大小和相对于视口的位置，注意这个大小是盒模型的大小，盒模型不同，所得到的值也不一样。

返回的rect对象拥有left、right、button、top、width、height、x、y八个属性。

```javascript
var lazyLoad = (function(target) {
  var imgList = [...document.querySelectorAll(target)]
  var total = imgList.length;
  var num = 0;
  return function() {
    var deleteImgIdx = [];
    imgList.forEach((img, idx) => {
      // 获取当前图片元素相对于视图窗口的距离
      var rect = img.getBoundingClientRect();
      if (rect.top < window.innerHeight) {
        // 表明图片已进入视图窗口
        deleteImgIdx.push(idx);
        num += 1;
      }
    })
    imgList = imgList.filter((img, idx) => !deleteImgIdx.includes(idx));
    if (num === total) {
      document.removeEventListener('scroll', lazyLoad)
    }
  }
})('img');
```

### 2.clientHeight + offsetTop + scrollTop

`clientHeight`：元素内部的高度，可以通过Height(css) + padding(css) - 水平滚动条高度计算得到。

`offsetTop`：返回当前元素相对于offsetParent元素的顶部内边距的距离。

`scrollTop`：有些情况下，元素中的内容的高度会超过元素本身的高度，当进行滚动时，内容碰到元素顶部时就会卷起来，scrollTop指的就是元素中卷起来的那部分内容的高度

|     scrollTop      |
——————————————————————
|                    |
|   元素本身的高度    |
——————————————————————
|                    |


```javascript
var lazyLoad = (function(selector){
  var imgList = [...document.querySelector(selector)];
  function getTop(e) {
    var T = e.offsetTop;
    while(e = e.offParent) {
      T += e.offsetTop;
    }
    return T;
  }

  return function() {
    var h = document.documentElement.clientHeight;
    var s = document.documentElement.scrollTop || document.body.scrollTop;
    var deleteImgIdx = [];
    for(let i = 0; i < imgList.length; i++) {
      if (h + s > getTop(imgList[i])) {
        imgList[i].src = imgList[i].dataset.src;
        deleteImgIdx.push(i);
      }
    }
    imgList = imgList.filter((img, idx) => !imgList.includes(idx));
  }
})('img')
```


### 3. IntersectionObserver

```javascript
var lazyLoad = function(selector){
  var imgList = document.querySelectorAll(selector);
  const observer = new IntersectionObserver(
    entries => {
      entries.forEach(entry => {
        if (entry.intersectionRatio > 0) {
          entry.target.src = dataset.src;
          observer.unobserve(entry.target)
        }
      })
    }
  );
  imgList.forEach(img => observer.observe(img))
}
```